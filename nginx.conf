server {
    listen 80 default_server;
    server_name localhost;

    # 1. ROOT DIRECTORY
    # We serve from 'dist' because that is the production build.
    root /home/not-manik/projects/NALUM/nalum/frontend/dist;
    index index.html;

    # 2. GZIP COMPRESSION (Copied from your snippet)
    # This compresses text files before sending them to the browser.
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # 4. API & WEBSOCKETS (MOVED BEFORE STATIC FILES)
    # The ^~ modifier prevents regex locations from matching
    # This ensures /api/ requests go to backend, not static file cache
    location ^~ /api/ {
        proxy_pass http://localhost:2478;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }

    # Optional: Socket.io support (if your app uses it)
    location ^~ /socket.io/ {
        proxy_pass http://localhost:2478;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # 3. CACHING FOR STATIC ASSETS (NOW AFTER API)
    # This regex won't match /api/ requests anymore due to ^~ modifier above
    location ~* \.(js|css|png|jpg|jpeg|gif|webp|svg|ico|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off; # Reduces log noise
    }

    # 5. FRONTEND ROUTING (Fallback)
    # If a file isn't found (and isn't an API call), serve index.html
    location / {
        try_files $uri $uri/ /index.html;
        # Don't cache index.html so users always get the latest version info
        add_header Cache-Control "no-cache";
    }
}
